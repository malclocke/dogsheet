new_timeslice = '<%= escape_javascript(render(:partial => 'timesheet_row', :locals => { :timeslice => @timeslice })) %>';
<% if @next %>
$('#timeslice-<%= @next.id %>').before(new_timeslice);
<% else %>
$('#timeslice-form-<%= @timeslice.date %>').before(new_timeslice);
<% end %>

$('#dayheader-<%= @timeslice.date %> > span.summary').replaceWith('<%= escape_javascript(render(:partial => 'timesummary', :locals => { :timeslices => @timeslices })) %>');

$('.taskbadge-<%= @timeslice.task.id %>').replaceWith('<%= escape_javascript(render(:partial => @timeslice.task)) %>');

/* Update the task select, in case a new task has been created */
$('#timeslice_task_id').replaceWith('<%= escape_javascript(
  collection_select(:timeslice, :task_id, @tasks, :id, :name_with_ancestors, 
                    {:include_blank => '-- Top level --'},{:class => 'autocomplete'})
) %>');
$('#timeslice_task_id').next('input.ac_input').remove();
$('#timeslice_task_id').val(<%= @task.parent_id %>);
$('#timeslice_task_id').select_autocomplete();
$('#task_name').val('');

<% next_finished = @timeslice.finished + current_user.time_step.minutes %>
$('#timeslice_started_time').val('<%= @timeslice.finished_time %>');
$('#timeslice_finished_time').val('<%= next_finished.to_s(:time_only) %>');
$('#timeslice_task_id').focus();
$('#timesheet-<%= @timeslice.date %> .no-timeslices').hide();
$('#timesheet-<%= @timeslice.date %>').toggle(true);
$('#dayheader-<%= @timeslice.date %>').removeClass('closed');

$('#timeslice-form-<%= @timeslice.date %> *').removeClass('fieldWithErrors');
$('#timeslice-form-errors').empty();
